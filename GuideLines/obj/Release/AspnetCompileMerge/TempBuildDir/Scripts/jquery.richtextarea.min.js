var JQE_MODE_VIEW="view";var JQE_MODE_HTML="html";jQuery.fn.richtextarea=function(b,a){for(i=0;i<this.length;i++){if((typeof(b)=="object"||typeof(b)=="undefined")&&typeof(this[i].richtextarea)=="undefined"){editor=new richtextarea();editor.setOptions(b);editor.initEditor(this[i])}else{ret=this[i].richtextarea.execFunc(b,a)}}if(typeof(ret)!="undefined"){return ret}else{return this}};richtextarea=function(){this.container=null;this.window=null;this.document=null;this.nodeName="";this.fontFamily="";this.textareaHTML=null;this.navigationPath=[];this.navBar=null;this.options={indentTab:true,tabCode:true,mode:JQE_MODE_VIEW,onChange:function(){},toolbar:true,navigationPath:false};this.execFunc=function(b,a){switch(b){case"bold":this.setBold();break;case"italic":this.setItalic();break;case"switch":this.switchMode();break;case"gethtml":return this.getHtml();break}};this.setOptions=function(a){if(typeof(a)=="object"){if(typeof(a.mode)!="undefined"){this.options.mode=a.mode}if(typeof(a.onChange)!="undefined"){this.options.onChange=a.onChange}if(typeof(a.navigationPath)!="undefined"){this.options.navigationPath=a.navigationPath}if(typeof(a.toolbar)!="undefined"){this.options.toolbar=a.toolbar}}};this.initEditor=function(a){this.nodeName=this.getNodeName(a);if(this.nodeName=="textarea"){this.textareaHTML=a;a.richtextarea=this;RichTextArea="";if(this.options.toolbar){RichTextArea+='<div class="ui-richtextarea-toolsbar ui-widget-header ui-widget-content ui-corner-all" unselectable="on">';RichTextArea+='<a href="#" class="ui-richtextarea-button ui-state-default" unselectable="on"><span class="ui-richtextarea-icon-bold ui-richtextarea-icon">Bold</span></a>';RichTextArea+='<a href="#" class="ui-richtextarea-button ui-state-default" unselectable="on"><span class="ui-richtextarea-icon-italic ui-richtextarea-icon">Italic</span></a>';RichTextArea+="</div>"}RichTextArea+='<div class="ui-richtextarea-content ui-widget-content">';RichTextArea+="</div>";if(this.options.navigationPath){RichTextArea+='<div class="ui-richtextarea-navbar ui-corner-all ui-widget-content">';RichTextArea+="</div>"}editor=document.createElement("div");jQuery(editor).html(RichTextArea);jQuery(editor).addClass("ui-widget ui-richtextarea ui-widget-content ui-corner-all");jQuery(a).after(editor);if(this.options.navigationPath){this.navBar=jQuery(editor).find(".ui-richtextarea-navbar").get(0)}if(this.options.toolbar){jQuery(editor).find(".ui-richtextarea-button").hover(function(){jQuery(this).addClass("ui-state-hover")},function(){jQuery(this).removeClass("ui-state-hover")});jQuery(editor).find(".ui-richtextarea-button").mousedown(function(b){return false});jQuery(editor).find(".ui-richtextarea-icon-italic").get(0).richtextarea=this;jQuery(editor).find(".ui-richtextarea-icon-italic").click(function(){this.richtextarea.setItalic()});jQuery(editor).find(".ui-richtextarea-icon-bold").get(0).richtextarea=this;jQuery(editor).find(".ui-richtextarea-icon-bold").click(function(){this.richtextarea.setBold()})}a=jQuery(editor).find(".ui-richtextarea-content").get(0);jQuery(a).html(jQuery(this.textareaHTML).text());jQuery(a).height(jQuery(this.textareaHTML).height());jQuery(editor).width(jQuery(this.textareaHTML).width());jQuery(this.textareaHTML).hide()}a.richtextarea=this;this.fontFamily=jQuery(a).css("font-family");this.container=a;this.window=window;this.document=window.document;this._activEditMode();this._attachEvent()};this._activEditMode=function(){this.container.designMode="On";this.container.contentEditable=true};this._attachEvent=function(){jQuery(this.container).keydown(function(a){return this.richtextarea.onKeyDown(a)});jQuery(this.container).dblclick(function(a){return this.richtextarea.onDblClick(a)});jQuery(this.container).mouseup(function(a){return this.richtextarea.onMouseUp(a)});jQuery(this.container).keyup(function(a){return this.richtextarea.onKeyUp(a)})};this.onMouseUp=function(a){this.setNavigationPath();return true};this.onDblClick=function(a){return true};this.onChange=function(a){if(this.textareaHTML){jQuery(this.textareaHTML).html(this.HtmlEncode(this.getHtml()))}if(typeof(this.options.onChange)=="function"){this.options.onChange(a)}return true};this.onSwitchMode=function(a){return true};this.onKeyDown=function(a){if(window.event){keyNum=a.keyCode}else{if(a.which){keyNum=a.which;if(keyNum==0){keyNum=a.keyCode}}}if(this.options.indentTab){if(keyNum==9){this.stopPropagation(a);return false}}if(keyNum==13){if(jQuery.browser.msie){this.insertHtml("<br/>",true,true);this.stopPropagation(a);return false}}this.onChange({func:"onKeyDown",event:a});return true};this.onKeyUp=function(a){this.setNavigationPath();this.onChange({func:"onKeyUp",event:a})};this.getSelection=function(){if(typeof(this.document.selection)!="undefined"){return this.document.selection}else{return this.window.getSelection()}};this.createRange=function(a){if(typeof(a)!="undefined"){if(typeof(a.createRange)!="undefined"){return a.createRange()}else{if(a.rangeCount>0){return a.getRangeAt(0)}else{return null}}}else{if(typeof(this.document.selection)!="undefined"){return this.document.selection.createRange()}else{return this.document.createRange()}}};this.setNavigationPath=function(){if(!this.options.navigationPath){return}element=this.getParentSelection();jQuery(this.navBar).html("");this.navigationPath=[];i=0;while(element!=this.container&&typeof(element)!="undefined"&&element.parentNode!=null){if(element.parentNode){this.navigationPath[i]=element;element=element.parentNode;i++}}for(i=this.navigationPath.length-1;i>-1;i--){if(this.navigationPath[i].nodeType!=3){jQuery(this.navBar).append('<a href="#" class="ui-richtextarea-nav'+i+' ui-state-default" unselectable="on"><span>'+this.getNodeName(this.navigationPath[i])+"</span></a>");navButton=jQuery(this.navBar).find(".ui-richtextarea-nav"+i).get(0);navButton.richtextarea=this;navButton.selElement=this.navigationPath[i];jQuery(navButton).click(function(){this.richtextarea.selectElement(this.selElement)})}}};this.getParentSelection=function(){element=undefined;selection=this.getSelection();range=this.createRange(selection);if(typeof(selection.type)!="undefined"){if(selection.type=="Control"){element=range(0).parentNode}else{element=range.parentElement()}}else{element=range.startContainer;if(element.nodeType==3){if(element.textContent==""){element=element.nextSibling}}}if(element.nodeType==3){element=element.parentNode}return element};this.selectElement=function(a){selection=this.getSelection();if(typeof(selection.selectAllChildren)!="undefined"){selection.selectAllChildren(a)}else{end_range=this.createRange();start_range=end_range.duplicate();start_range.moveToElementText(a);start_range.setEndPoint("EndToEnd",end_range);a.selectionStart=start_range.text.length-end_range.text.length;a.selectionEnd=a.selectionStart+end_range.text.length}};this.insertHtml=function(b,a,c){if(typeof(c)=="undefined"){c=false}if(typeof(a)=="undefined"){a=true}this.container.focus();selection=this.getSelection();range=this.createRange(selection);if(jQuery.browser.msie){range.HTMLText="";range.pasteHTML(b);range.collapse(false);if(a){divElement=this.document.createElement("div");divElement.innerHTML=b;text=divElement.innerText;textLength=text.length;if(textLength>0){range.moveStart("character",-textLength)}range.select()}}else{range.deleteContents();selection.removeAllRanges();rangeElement=this.createRange();fragment=rangeElement.createContextualFragment(b);firstElement=fragment.firstChild;if(firstElement.nodeType==3){if(firstElement.textContent==" "){fragment.removeChild(firstElement);firstElement=fragment.firstChild}}lastElement=fragment.lastChild;nodeStart=range.startContainer;offset=range.startOffset;switch(nodeStart.nodeType){case 3:if(fragment.nodeType==3){nodeStart.insertData(offset,fragment.data);range=this.createRange();range.setEnd(nodeStart,offset+fragmentLength);range.setStart(nodeStart,offset+fragmentLength);selection.addRange(range)}else{nodeStart=nodeStart.splitText(offset);nodeStart.parentNode.insertBefore(fragment,nodeStart)}break;case 1:nodeStart.insertBefore(fragment,nodeStart.childNodes[offset]);break}if(a){if(firstElement!=null&&lastElement.nextSibling!=null){range=this.createRange();range.setStart(firstElement,0);range.setEnd(lastElement.nextSibling,0);selection.removeAllRanges();selection.addRange(range)}}}this.setNavigationPath()};this.getSelectedFragment=function(){selection=this.getSelection();range=this.createRange(selection);if(typeof(range.htmlText)!="undefined"){return this.getFragment(range.htmlText)}else{if(range.collapsed){return null}divElement=this.document.createElement("div");divElement.appendChild(range.cloneContents());return divElement}};this.getSelectedHtml=function(){selection=this.getSelection();range=this.createRange(selection);if(jQuery.browser.msie){return range.htmlText}else{if(range.collapsed){return""}fragment=range.cloneContents();divElement=this.document.createElement("div");jQuery(divElement).append(fragment);return jQuery(divElement).html()}};this.setStyle2=function(b,a,c){fragment=this.getSelectedFragment();this.setAllStyleStyle(fragment,b,a,c);this.insertHtml(jQuery(fragment).html())};this.setAllStyleStyle=function(b,c,a,d){for(i=0;i<b.childNodes.length;i++){this.setAllStyleStyle(b.childNodes[i],c,a,d)}if(b.nodeType==3){myParent=b.parentNode;if(this.getNodeName(myParent)=="span"){this.setElementStyle(myParent,c,a,d)}else{spanElement=this.document.createElement("span");this.setElementStyle(spanElement,c,a,d);jQuery(b).after(spanElement);jQuery(spanElement).append(b)}}};this.setElementStyle=function(b,c,a,d){currentValue=new String(jQuery(b).css(c));finded=false;if(typeof(a)=="object"){for(index in a){if(currentValue.toLowerCase()==a[index].toLowerCase()){finded=true;break}}setValue=a[0]}else{if(currentValue.toLowerCase()==a.toLowerCase()){finded=true}setValue=a}if(finded){jQuery(b).css(c,d)}else{jQuery(b).css(c,setValue)}};this.setStyle=function(b,a,c){html=this.getSelectedHtml();parentSelection=this.getParentSelection();nodeName=this.getNodeName(parentSelection);if(parentSelection){if(parentSelection.nodeType==3){parentcontent=parentSelection.textContent.toLowerCase()}else{parentcontent=parentSelection.innerHTML.toLowerCase()}}if(html==""){return}if(this.outerHTML(parentSelection).toLowerCase()==html.toLowerCase()&&nodeName=="span"){this.setElementStyle(parentSelection,b,a,c)}else{if(typeof(a)=="object"){this.insertHtml('<span style="'+b+":"+a[0]+';">'+html+"</span>")}else{this.insertHtml('<span style="'+b+":"+a+';">'+html+"</span>")}}};this.clearObsoletSpan=function(){jQuery(this.container).find("span").each(function(){if(jQuery(this).html()==""){jQuery(this).remove()}})};this.HtmlEncode=function(a){a=new String(a);a=a.replace(/&/g,"&amp;");a=a.replace(/"/g,"&quot;");a=a.replace(/</g,"&lt;");a=a.replace(/>/g,"&gt;");a=a.replace(/\'/g,"&#39;");return a};this.HtmlDecode=function(a){a=new String(a);a=a.replace(/&quot;/g,'"');a=a.replace(/&amp;/g,"&");a=a.replace(/&#39;/g,"'");a=a.replace(/&lt;/g,"<");a=a.replace(/&gt;/g,">");return a};this.switchMode=function(){if(this.options.mode==JQE_MODE_VIEW){this.options.mode=JQE_MODE_HTML;this.container.innerHTML=this.HtmlEncode(this.container.innerHTML);jQuery(this.container).css("font-family","Courier New")}else{this.options.mode=JQE_MODE_VIEW;this.container.innerHTML=this.HtmlDecode(this.container.innerHTML);jQuery(this.container).css("font-family",this.fontFamily)}this.onSwitchMode({mode:this.options.mode})};this.getFragment=function(a){fragment=this.document.createElement("div");jQuery(fragment).html(a);return fragment};this.getHtml=function(){if(this.options.mode==JQE_MODE_VIEW){return this.container.innerHTML}else{return jQuery(this.container).text()}};this.setHtml=function(a){this.container.innerHTML=a;this.onChange({func:"setHtml"})};this.setBold=function(){if(this.options.mode==JQE_MODE_HTML){return}this.document.execCommand("bold",false,null);this.onChange({func:"setBold"})};this.setItalic=function(){if(this.options.mode==JQE_MODE_HTML){return}this.document.execCommand("italic",false,null);this.onChange({func:"setItalic"})};this.setColor=function(a){if(this.options.mode==JQE_MODE_HTML){return}this.document.execCommand("forecolor",false,a);this.onChange({func:"setColor"})};this.setLink=function(a){if(this.options.mode==JQE_MODE_HTML){return}this.container.focus();if(a==""||!a){if(jQuery.browser.msie){this.document.execCommand("createlink",true,"")}else{a=window.prompt("Url","http://");this.document.execCommand("createlink",false,a)}}else{this.document.execCommand("createlink",false,a)}this.onChange({func:"setLink",link:a})};this.deleteSelection=function(){this.document.execCommand("delete",false,null);this.onChange({func:"deleteSelection"})};this.setIndent=function(){if(this.options.mode==JQE_MODE_HTML){return}this.document.execCommand("indent",false,null);this.onChange({func:"setIndent"})};this.setFontSize=function(a){if(this.options.mode==JQE_MODE_HTML){return}this.setStyle("font-size",a,"medium");this.onChange({func:"setFontSize",size:a})};this.removeFormat=function(){if(this.options.mode==JQE_MODE_HTML){return}if(jQuery.browser.msie){divElement=this.document.createElement("div");jQuery(divElement).html(this.getSelectedHtml());jQuery(divElement).find("span").each(function(){jQuery(this).attr("style"," ")});this.insertHtml(jQuery(divElement).html());this.clearObsoletSpan()}else{this.document.execCommand("removeformat",false,null)}this.onChange({func:"removeFormat"})};this.stopPropagation=function(a){if(!a){a=window.event;a.cancelBubble=true}if(a.stopPropagation){a.stopPropagation()}};this.getNodeName=function(a){if(typeof(a.tagName)!="undefined"){return a.tagName.toLowerCase()}else{return a.nodeName.toLowerCase()}};this.outerHTML=function(a){if(typeof(a.outerHTML)!="undefined"){return a.outerHTML}else{divElement=this.document.createElement("div");newElement=a.cloneNode(true);jQuery(divElement).append(newElement);return jQuery(divElement).html()}}};